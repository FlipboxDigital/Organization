(function($){Craft.OrganizationUserIndex=Craft.BaseElementIndex.extend({init:function(elementType,$container,settings){this.setSettings(settings,Craft.OrganizationUserIndex.defaults);this.base(elementType,$container,settings);this.removeListener(Garnish.$win,"resize,scroll");this.$toolbar.removeClass("fixed");this.$toolbar.css("width","");this.$elements.css("padding-top","");this.$toolbar.css("top","0")},getViewParams:function(){var params=this.base();params.organization=this.settings.sourceElementId;return params},afterAction:function(action,params){Craft.cp.runPendingTasks();this.onAfterAction(action,params)},onAfterAction:function(action,params){this.settings.onAfterAction(action,params);this.trigger("afterAction",{action:action,params:params})},updateElements:function(){if(!this.initialized){return}this.setIndexBusy();var params=this.getViewParams();Craft.postActionRequest("organization/user-indexes/get-elements",params,$.proxy(function(response,textStatus){this.setIndexAvailable();if(textStatus=="success"){this._updateView(params,response)}else{Craft.cp.displayError(Craft.t("app","An unknown error occurred."))}},this))},submitAction:function(actionClass,actionParams){var selectedElementIds=this.view.getSelectedElementIds(),totalSelected=selectedElementIds.length,totalItems=this.view.getEnabledElements.length;if(totalSelected==0){return}var action;for(var i=0;i<this.actions.length;i++){if(this.actions[i].type==actionClass){action=this.actions[i];break}}if(!action||action.confirm&&!confirm(action.confirm)){return}var viewParams=this.getViewParams();var params=$.extend(viewParams,actionParams,{elementAction:actionClass,elementIds:selectedElementIds});this.setIndexBusy();this._autoSelectElements=selectedElementIds;Craft.postActionRequest("organization/user-indexes/perform-action",params,$.proxy(function(response,textStatus){this.setIndexAvailable();if(textStatus=="success"){if(response.success){this._updateView(viewParams,response);if(response.message){Craft.cp.displayNotice(response.message)}this.afterAction(action,params)}else{Craft.cp.displayError(response.message)}}},this))}},{defaults:{onAfterAction:$.noop,sourceElementId:null}});Craft.registerElementIndexClass("craft\\elements\\User",Craft.OrganizationUserIndex);Craft.OrganizationUserSelectInput=Craft.BaseElementSelectInput.extend({init:function(settings){this.setSettings(settings,Craft.OrganizationUserSelectInput.defaults);this.base(settings);this.$elements=[];this.$addElementBtn.css("position","").css("top","").css(Craft.left,"")},resetElements:function(){this.$elements=[];this.addElements(this.getElements())},_getIdFromElement:function($element){var id=$element;if(typeof $element=="object"){id=$($element).data("id")}return id},getElements:function(){return this.$elementsContainer.children(".element")},addElements:function($elements){$elements=$.makeArray($elements);for(var i=0;i<$elements.length;i++){var id=this._getIdFromElement($elements[i]);this.$elements.push(id)}},removeElements:function($elements){$elements=$.makeArray($elements);var ids=[];for(var i=0;i<$elements.length;i++){var id=$elements[i];if(!isNaN(id)){id=parseInt(this._getIdFromElement(id))}Craft.removeFromArray(id,this.$elements);ids.push(id)}if(this.modal){this.modal.elementIndex.enableElementsById(ids)}this.onRemoveElements()},removeElement:function($element){this.removeElements($element)},getSelectedElementIds:function(){return this.$elements},selectElements:function(elements){for(var i=0;i<elements.length;i++){var element=elements[i],$element=this.createNewElement(element),elementInfo=Craft.getElementInfo($element);this.addElements($element);var data={user:elementInfo.id,organization:this.settings.sourceElementId};Craft.postActionRequest(this.settings.addAction,data,$.proxy(function(response,textStatus){if(textStatus=="success"){Craft.elementIndex.updateElements()}else{this.removeElements($element);this.updateDisabledElementsInModal()}},this))}},getDisabledElementIds:function(){var ids=this.base();if(this.settings.disabledElementIds){ids=ids.concat(this.settings.disabledElementIds)}return ids}},{defaults:{addAction:"",disabledElementIds:[]}});Craft.OrganizationOwnerSelectInput=Craft.BaseElementSelectInput.extend({init:function(settings){this.setSettings(settings,Craft.OrganizationUserSelectInput.defaults);this.base(settings)},getDisabledElementIds:function(){var ids=this.base();if(this.settings.disabledElementIds){ids=ids.concat(this.settings.disabledElementIds)}return ids}},{defaults:{addAction:"",disabledElementIds:[]}});Craft.OrganizationTypeSwitcher=Garnish.Base.extend({$container:null,$activeButton:null,activeBtn:null,$availableButton:null,availableBtn:null,$spinner:null,$fields:null,init:function(){this.$container=$("#types");this.$activeButton=this.$container.find("#active");this.$availableButton=this.$container.find("#available");this.$spinner=$('<div class="spinner hidden"/>').insertAfter(this.$availableButton);this.$fields=$("#fields");this.activeBtn=this.$activeButton.menubtn().data("menubtn");this.initActiveBtnListener();this.availableBtn=this.$availableButton.menubtn().data("menubtn");this.initAvailableBtnListener()},initActiveBtn:function(){this.activeBtn=new Garnish.MenuBtn(this.$activeButton);var $hr=this.activeBtn.menu.$menuList.find("hr");if($hr.length){if(this.activeBtn.menu.$menuList.children("li").length==1){$hr.hide()}else{$hr.show()}}this.initActiveBtnListener()},initActiveBtnListener:function(){this.activeBtn.on("optionSelect",$.proxy(this,"_handleTypeChange"))},initAvailableBtnListener:function(){this.availableBtn.on("optionSelect",$.proxy(this,"_handleAvailableSelect"))},initAvailableBtn:function(){this.availableBtn=new Garnish.MenuBtn(this.$availableButton);this.initAvailableBtnListener()},_handleAvailableSelect:function(ev){var $option=$(ev.option);if($option.hasClass("disabled")){return}if($option.children(".status").hasClass("active")){this.dissociateType($option.data("type"),$option.data("organization"))}else{this.associateType($option.data("type"),$option.data("organization"))}},_handleTypeChange:function(ev){var $option=$(ev.option);if($option.hasClass("disabled")){return}this.changeType($option)},changeType:function($option){var $menu=$option.parents("ul");$menu.find(".sel").removeClass("sel");$option.addClass("sel");var value=$option.attr("data-id");var label=$option.html();this.$activeButton.html('<input type="hidden" name="type" value="'+value+'">'+label);this.initActiveBtn();this.switchType()},getActiveTypeId:function(){var $input=this.$activeButton.find('input[name="type"]');if(!$input.length){return}return $input.val()},ensureAvailableSelected:function(){var $active=this.getActiveOption(this.getActiveTypeId());if($active){return}$active=this.getNextActiveOption();if(!$active){return}this.changeType($active)},getAvailableOption:function(type){var $option=this.availableBtn.menu.$options.filter('[data-type="'+type+'"]');if(!$option.length){return}return $option},getActiveOption:function(id){var $active=this.activeBtn.menu.$options.filter('[data-id="'+id+'"]');if(!$active.length){return}return $active},getNextActiveOption:function(id){var $active=this.activeBtn.menu.$options.first();if(!$active.length){return}return $active},associateType:function(type,organization){var data={type:type,organization:organization};var $option=this.getAvailableOption(type);if(!$option){return}$option.children(".status").addClass("active");var value=$option.attr("data-type");var label=$("<div/>").html($option.html()).text();this.activeBtn.menu.$menuList.append($('<li><a data-id="'+value+'">'+label+"</a></li>"));if(value){this.$availableButton.append($("<input />").attr("name","types[]").attr("type","hidden").val(value))}this.initActiveBtn()},dissociateType:function(type,organization){var data={type:type,organization:organization};var $option=this.getAvailableOption(type);if(!$option){return}$option.children(".status").removeClass("active");var value=$option.attr("data-type");var $active=this.getActiveOption(value);if(!$active){return}$active.parent("li").remove();var $input=this.$availableButton.find('input[name="types[]"][value="'+value+'"]');if($input.length){$input.remove()}this.initActiveBtn();this.ensureAvailableSelected()},switchType:function(){this.$spinner.removeClass("hidden");Craft.postActionRequest("organization/view/organization/switch-type",Craft.cp.$container.serialize(),$.proxy(function(response,textStatus){this.$spinner.addClass("hidden");if(textStatus=="success"){var fieldsPane=this.$fields.data("pane");fieldsPane.deselectTab();var $usersTabLink=this.$fields.find('#tabs ul li a[href="#tab-users"]');var $usersTab=$usersTabLink.parent("li").clone();var $usersContent=this.$fields.find($usersTabLink.attr("href")).clone();this.$fields.html(response.paneHtml);fieldsPane.destroy();this.$fields.append($usersContent).find("#tabs ul").append($usersTab);this.$fields.pane();Craft.initUiElements(this.$fields);Craft.appendHeadHtml(response.headHtml);Craft.appendFootHtml(response.footHtml);if(typeof slugGenerator!=="undefined"){slugGenerator.setNewSource("#title")}}},this))}})})(jQuery);